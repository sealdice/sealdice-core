name: dnd5e
fullName: 龙与地下城5E
authors: [木落]
version: 1.0.0
updatedTime: '20251004'
templateVer: '2.0'

initScript: |
  func skillShowValueAs(val) {
    return `{val}[{&val.base??0}]`
  }

  func skillShowKeyAs(key, val) {
    return `{key}{&val.factor ? '*'+ (&val.factor == 1 ? '' : str(&val.factor)) }`
  }

  func abilityShowKeyAs(key, keyFactor) {
    return `{key}{keyFactor ? '*'+ (keyFactor == 1 ? '' : str(keyFactor)) }`
  }

  func pbCalc(base, factor, ab) { // 基础值，熟练系数，属性值
    return base + (ab??0)/2 - 5 + floor((熟练??0) * (factor??0));
  }

  func abilityModifier(name) { // 计算调整值
    return (load(name) ?? 0) / 2 - 5
  }

  func savingDetail(name) {
    buffPart = load(`$buff_{name}豁免`) ?? 0;
    buffPart = buffPart ? `+buff{buffPart}` : ''; 
    return `调整值{abilityModifier(name)}+熟练{熟练 * load('$stp_'+name)}{buffPart}`
  }

  func skillDetail(val, attrName) {
    buffPart = load(`$buff_{attrName}豁免`) ?? 0;
    buffPart = buffPart ? `+buff{buffPart}` : '';
    return `基础{&val.base}+{attrName}调整值{abilityModifier(attrName)}+熟练{floor((熟练??0) * (&val.factor??0))}{buffPart}`
  }

attrs: # 属性
  defaults: # 默认值
    熟练: 2

  defaultsComputed: # 计算默认值
    pp: 10 + 察觉

    力量调整值: abilityModifier('力量')
    体质调整值: abilityModifier('体质')
    敏捷调整值: abilityModifier('敏捷')
    智力调整值: abilityModifier('智力')
    感知调整值: abilityModifier('感知')
    魅力调整值: abilityModifier('魅力')

    # 基础技能在没有进行设置的情况下等于调整值
    运动: 力量调整值

    体操: 敏捷调整值
    巧手: 敏捷调整值
    隐匿: 敏捷调整值

    调查: 智力调整值
    奥秘: 智力调整值
    历史: 智力调整值
    自然: 智力调整值
    宗教: 智力调整值

    察觉: 感知调整值
    洞悉: 感知调整值
    驯兽: 感知调整值
    医药: 感知调整值
    求生: 感知调整值

    游说: 魅力调整值
    欺瞒: 魅力调整值
    威吓: 魅力调整值
    表演: 魅力调整值

    力量豁免: pbCalc(0, load('$stp_力量') ?? 0, 力量)
    体质豁免: pbCalc(0, load('$stp_体质') ?? 0, 体质)
    敏捷豁免: pbCalc(0, load('$stp_敏捷') ?? 0, 敏捷)
    智力豁免: pbCalc(0, load('$stp_智力') ?? 0, 智力)
    感知豁免: pbCalc(0, load('$stp_感知') ?? 0, 感知)
    魅力豁免: pbCalc(0, load('$stp_魅力') ?? 0, 魅力)

  detailOverwrite: # 计算过程提示重写
    pp: "'10+察觉'"

    体质豁免: "savingDetail('体质')"
    力量豁免: "savingDetail('力量')"
    感知豁免: "savingDetail('感知')"
    敏捷豁免: "savingDetail('敏捷')"
    智力豁免: "savingDetail('智力')"
    魅力豁免: "savingDetail('魅力')"

    体操: "skillDetail(&体操, '敏捷')"
    巧手: "skillDetail(&巧手, '敏捷')"
    隐匿: "skillDetail(&隐匿, '敏捷')"

    调查: "skillDetail(&调查, '智力')"
    奥秘: "skillDetail(&奥秘, '智力')"
    历史: "skillDetail(&历史, '智力')"
    自然: "skillDetail(&自然, '智力')"
    宗教: "skillDetail(&宗教, '智力')"

    察觉: "skillDetail(&察觉, '感知')"
    洞悉: "skillDetail(&洞悉, '感知')"
    驯兽: "skillDetail(&驯兽, '感知')"
    医药: "skillDetail(&医药, '感知')"
    求生: "skillDetail(&求生, '感知')"

    游说: "skillDetail(&游说, '魅力')"
    欺瞒: "skillDetail(&欺瞒, '魅力')"
    威吓: "skillDetail(&威吓, '魅力')"
    表演: "skillDetail(&表演, '魅力')"

    力量调整值: "''"
    体质调整值: "''"
    敏捷调整值: "''"
    智力调整值: "''"
    感知调整值: "''"
    魅力调整值: "''"

alias: # 别名
  力量: [str, Strength]
  敏捷: [dex, Dexterity]
  体质: [con, Constitution, 體質, 體魄, 体魄]
  智力: [int, Intelligence]
  感知: [wis, Wisdom]
  魅力: [cha, Charisma]

  ac: [AC, 护甲等级, 护甲值, 护甲, 護甲等級, 護甲值, 護甲, 装甲, 裝甲]
  hp: [HP, 生命值, 生命, 血量, 体力, 體力, 耐久值]
  hpmax: [HPMAX, 生命值上限, 生命上限, 血量上限, 耐久上限]
  dc: [DC, 难度等级, 法术豁免, 難度等級, 法術豁免]
  hd: [HD, 生命骰]
  pp: [PP, 被动察觉, 被动感知, 被動察覺, 被动感知, PW]

  熟练: ["熟练加值", "熟練", "熟練加值"]
  体型: ["siz", "size", "體型", "体型", "体形", "體形"]

  # 技能
  运动: ["Athletics", "運動"]

  体操: ["Acrobatics", "杂技", "特技", "體操", "雜技", "特技動作", "特技动作"]
  巧手: ["Sleight of Hand", "上手把戲", "上手把戏"]
  隐匿: ["Stealth", "隱匿", "潜行", "潛行"]

  调查: ["Investigation", "調查"]
  奥秘: ["Arcana", "奧秘"]
  历史: ["History", "歷史"]
  自然: ["Nature"]
  宗教: ["Religion"]

  察觉: ["Perception", "察覺", "觉察", "覺察"]
  洞悉: ["Insight", "洞察", "察言觀色", "察言观色"]
  驯兽: ["Animal Handling", "馴獸", "驯养", "馴養", "動物馴服", "動物馴養", "动物驯服", "动物驯养"]
  医药: ["Medicine", "醫藥", "医疗", "醫療"]
  求生: ["Survival", "生存"]

  游说: ["Persuasion", "说服", "话术", "遊說", "說服", "話術"]
  欺瞒: ["Deception", "唬骗", "欺诈", "欺骗", "诈骗", "欺瞞", "唬騙", "欺詐", "欺騙", "詐騙"]
  威吓: ["Intimidation", "恐吓", "威嚇", "恐嚇"]
  表演: ["Performance"]

commands: # 具体的指令设置
  set:
    diceSides: '20'
    keys:
      - dnd
      - dnd5e
    relatedExt:
      - dnd5e

  sn:
    dnd:
      template: '{$t玩家_RAW} HP{hp}/{hpmax} AC{ac} DC{dc} PP{pp}'
      helpText: 自动设置dnd名片

  st:
    show: # show时显示的值
      top: [力量, 敏捷, 体质, 体型, 魅力, 智力, 感知, hp, ac, 熟练]
      sortBy: Name
      ignores:
        - DSS
        - DSF
        - hpmax
      showValueAs: # 影响单个属性的右侧内容
        '*': '{loadRaw(name)}'
        hp: '{hp??0}/{hpmax??0}'

        运动: '{skillShowValueAs(&运动)}'

        体操: '{skillShowValueAs(&体操)}'
        巧手: '{skillShowValueAs(&巧手)}'
        隐匿: '{skillShowValueAs(&隐匿)}'

        调查: '{skillShowValueAs(&调查)}'
        奥秘: '{skillShowValueAs(&奥秘)}'
        历史: '{skillShowValueAs(&历史)}'
        自然: '{skillShowValueAs(&自然)}'
        宗教: '{skillShowValueAs(&宗教)}'

        察觉: '{skillShowValueAs(&察觉)}'
        洞悉: '{skillShowValueAs(&洞悉)}'
        驯兽: '{skillShowValueAs(&驯兽)}'
        医药: '{skillShowValueAs(&医药)}'
        求生: '{skillShowValueAs(&求生)}'

        游说: '{skillShowValueAs(&游说)}'
        欺瞒: '{skillShowValueAs(&欺瞒)}'
        威吓: '{skillShowValueAs(&威吓)}'
        表演: '{skillShowValueAs(&表演)}'
      showKeyAs: # 影响单个属性的左侧内容
        # 六大属性
        力量: "{abilityShowKeyAs('力量', $stp_力量)}"
        敏捷: "{abilityShowKeyAs('敏捷', $stp_敏捷)}"
        体质: "{abilityShowKeyAs('体质', $stp_体质)}"
        智力: "{abilityShowKeyAs('智力', $stp_智力)}"
        感知: "{abilityShowKeyAs('感知', $stp_感知)}"
        魅力: "{abilityShowKeyAs('魅力', $stp_魅力)}"

        # 力量相关技能
        运动: "{skillShowKeyAs('运动', &运动)}"

        # 敏捷相关技能
        体操: "{skillShowKeyAs('体操', &体操)}"
        巧手: "{skillShowKeyAs('巧手', &巧手)}"
        隐匿: "{skillShowKeyAs('隐匿', &隐匿)}"

        # 智力相关技能
        调查: "{skillShowKeyAs('调查', &调查)}"
        奥秘: "{skillShowKeyAs('奥秘', &奥秘)}"
        历史: "{skillShowKeyAs('历史', &历史)}"
        自然: "{skillShowKeyAs('自然', &自然)}"
        宗教: "{skillShowKeyAs('宗教', &宗教)}"

        # 感知相关技能
        察觉: "{skillShowKeyAs('察觉', &察觉)}"
        洞悉: "{skillShowKeyAs('洞悉', &洞悉)}"
        驯兽: "{skillShowKeyAs('驯兽', &驯兽)}"
        医药: "{skillShowKeyAs('医药', &医药)}"
        求生: "{skillShowKeyAs('求生', &求生)}"

        # 魅力相关技能
        游说: "{skillShowKeyAs('游说', &游说)}"
        欺瞒: "{skillShowKeyAs('欺瞒', &欺瞒)}"
        威吓: "{skillShowKeyAs('威吓', &威吓)}"
        表演: "{skillShowKeyAs('表演', &表演)}"
