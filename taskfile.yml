# https://taskfile.dev

version: '3'

vars:
  CORE_DIR: core
  UI_DIR: ui
  ANDROID_DIR: android
  MANUAL_DIR: manual
  STORY_PAINTER_DIR: story-painter
  VERIFY_DIR: verify

  CORE_BINARY_NAME: sealdice-core
  CORE_BINARY_PATH: "{{.CORE_DIR}}/{{.BACKEND_BINARY_NAME}}"
  UI_BUILD_DIR: dist

tasks:
  default:
    desc: "æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨ä»»åŠ¡"
    cmds:
      - task --list-all
    silent: true

  doctor:
    desc: "æ£€æµ‹å¿…éœ€çš„å¼€å‘å·¥å…·æ˜¯å¦å·²å®‰è£…"
    summary: |
      æ­¤å‘½ä»¤ä¼šæ£€æŸ¥ä»¥ä¸‹å·¥å…·æ˜¯å¦åœ¨ PATH ä¸­å¯ç”¨ï¼š
        - git
        - go
        - golangci-lint
        - pnpm
        # - lefthook
    cmds:
      # æš‚æ—¶å…ˆä¸å¼•å…¥ lefthook
      # - defer: { task: doctor:lefthook, silent: true }
      - defer: { task: doctor:pnpm, silent: true }
      - defer: { task: doctor:golangci-lint, silent: true }
      - defer: { task: doctor:go, silent: true }
      - defer: { task: doctor:git, silent: true }

  doctor:git:
    internal: true
    preconditions:
      - sh: "command -v git"
        msg: |
          ğŸ”´ git æœªå®‰è£…ï¼
    cmds:
      - cmd: 'echo "ğŸŸ¢ git å·²å®‰è£… ($(git version))"'

  doctor:go:
    internal: true
    preconditions:
      - sh: "command -v go"
        msg: |
          ğŸ”´ go æœªå®‰è£…ï¼è¯·å‚è€ƒ https://go.dev/doc/install è¿›è¡Œå®‰è£…
    cmds:
      - cmd: 'echo "ğŸŸ¢ go å·²å®‰è£… ($(go version))"'

  doctor:golangci-lint:
    internal: true
    preconditions:
      - sh: "command -v golangci-lint"
        msg: |
          ğŸ”´ golangci-lint æœªå®‰è£…ï¼è¯·å‚è€ƒ https://golangci-lint.run/docs/welcome/install/ è¿›è¡Œå®‰è£…
        silent: true
    cmds:
      - cmd: 'echo "ğŸŸ¢ golangci-lint å·²å®‰è£… ($(golangci-lint version))"'

  doctor:pnpm:
    internal: true
    preconditions:
      - sh: "command -v pnpm"
        msg: |
          ğŸ”´ pnpm æœªå®‰è£…ï¼è¯·å‚è€ƒ https://pnpm.io/zh/installation è¿›è¡Œå®‰è£…
    cmds:
      - cmd: 'echo "ğŸŸ¢ pnpm å·²å®‰è£… (version: v$(pnpm --version))"'

  doctor:lefthook:
    internal: true
    preconditions:
      - sh: "command -v lefthook"
        msg: |
          ğŸ”´ lefthook æœªå®‰è£…ï¼è¯·å‚è€ƒ https://lefthook.dev/installation/ è¿›è¡Œå®‰è£…
    cmds:
      - cmd: 'echo "ğŸŸ¢ lefthook å·²å®‰è£… (version: v$(lefthook version))"'

  install:
    desc: "å®‰è£…é¡¹ç›®ä¾èµ–"
    cmds:
      - task: install:go
      - task: install:pnpm

  install:go:
    desc: "å®‰è£… go ä¾èµ–"
    dir: "{{.CORE_DIR}}"
    sources:
      - go.mod
      - go.sum
    cmds:
      - go mod tidy
      - go mod download

  install:pnpm:
    desc: "å®‰è£… pnpm ä¾èµ–"
    sources:
      - package.json
      - pnpm-lock.yaml
      - pnpm-workspace.yaml
    generates:
      - node_modules/**
    cmds:
      - pnpm install

  dev:core:
    desc: "å¯åŠ¨ core å¼€å‘è¿›ç¨‹"
    deps: [ install:go, build:ui ]
    dir: "{{.CORE_DIR}}"
    cmds:
      - go run {{.CORE_BINARY_NAME}}

  dev:ui:
    desc: "å¯åŠ¨ ui å¼€å‘è¿›ç¨‹"
    deps: [ install:pnpm ]
    cmds:
      - pnpm run dev:ui

  dev:manual:
    desc: "å¯åŠ¨ manual å¼€å‘è¿›ç¨‹"
    deps: [ install:pnpm ]
    cmds:
      - pnpm run dev:manual

  dev:story-painter:
    desc: "å¯åŠ¨ story-painter å¼€å‘è¿›ç¨‹"
    deps: [ install:pnpm ]
    cmds:
      - pnpm run dev:story-painter

  dev:verify:
    desc: "å¯åŠ¨ verify å¼€å‘è¿›ç¨‹"
    deps: [ install:pnpm ]
    cmds:
      - pnpm run dev:verify

  build:ui:
    desc: "æ„å»º ui é™æ€èµ„æº"
    cmds:
      - pnpm build:ui
      - rm -rf core/static/frontend
      - mkdir -p core/static/frontend
      - cp -r ui/dist/* core/static/frontend/
    sources:
      - ui/src/**
      - ui/public/**
      - ui/index.html
      - ui/postcss.config.*
      - ui/package.json
      - ui/tsconfig.**
      - ui/vite.config.*
    generates:
      - ui/dist/**
      - core/static/frontend/**
