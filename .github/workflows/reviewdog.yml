name: Review Dog

on:
  pull_request_target:
    paths:
      - ".github/workflows/reviewdog.yml"
      - "core/**.go"
      - "core/go.mod"
      - "ui/**.{js,mjs,cjs,jsx,ts,mts,cts,tsx,vue}"
      - "ui/package.json"
      - "package.json"
      - "pnpm-lock.yaml"

jobs:
  review-dog-go:
    name: Review Dog (Go)
    permissions:
      checks: write
      contents: read
      pull-requests: write
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: core
    steps:
      - name: Code
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.head_ref }}
      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache-dependency-path: core/go.mod
      - run: go get
      - run: go generate ./...
      - name: Set Up GolangCI-Lint
        run: curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v2.4.0
      - uses: reviewdog/action-setup@v1
        with:
          reviewdog_version: latest
      - name: Run golangci-lint & reviewdog
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          golangci-lint run | reviewdog -reporter=github-pr-review -f=golangci-lint -filter-mode=nofilter -fail-level=any

  review-dog-node:
    name: Review Dog (Node)
    permissions:
      checks: write
      contents: read
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - name: Code
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.head_ref }}
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest
          run_install: false
      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "pnpm"
      - name: Install Reviewdog
        uses: reviewdog/action-setup@v1
        with:
          reviewdog_version: latest
      - name: Run eslint & reviewdog (UI)
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        working-directory: ./ui
        run: |
          pnpm exec eslint -f rdjson . | reviewdog -f=rdjson -reporter=github-pr-review -filter-mode=nofilter -fail-level=any
